#!/bin/sh

echo "üîç Detecting changed packages..."

# Get all staged files
STAGED_FILES=$(git diff --cached --name-only)

# Detect which packages have changes
APP_CHANGED=false
CURRICULUM_CHANGED=false
INTERPRETERS_CHANGED=false
CONTENT_CHANGED=false

for file in $STAGED_FILES; do
  if echo "$file" | grep -q "^app/"; then
    APP_CHANGED=true
  elif echo "$file" | grep -q "^curriculum/"; then
    CURRICULUM_CHANGED=true
  elif echo "$file" | grep -q "^interpreters/"; then
    INTERPRETERS_CHANGED=true
  elif echo "$file" | grep -q "^content/"; then
    CONTENT_CHANGED=true
  fi
done

# Build all packages in dependency order (always runs to ensure everything is available)
echo "\nüî® Building packages in dependency order..."
FAILED=false

echo "Building interpreters..."
cd interpreters && pnpm run build
if [ $? -ne 0 ]; then
  echo "‚ùå Failed to build interpreters"
  FAILED=true
fi
cd ..

echo "Building curriculum..."
cd curriculum && pnpm run build
if [ $? -ne 0 ]; then
  echo "‚ùå Failed to build curriculum"
  FAILED=true
fi
cd ..

echo "Building content..."
cd content && pnpm run build
if [ $? -ne 0 ]; then
  echo "‚ùå Failed to build content"
  FAILED=true
fi
cd ..

if [ "$FAILED" = true ]; then
  echo "\n‚ùå Build failed in one or more packages"
  exit 1
fi

echo "‚úÖ All packages built successfully\n"

# Run pre-commit hooks for changed packages

if [ "$APP_CHANGED" = true ]; then
  echo "\nüì¶ Running app pre-commit checks..."
  cd app && ./scripts/pre-commit
  if [ $? -ne 0 ]; then
    FAILED=true
  fi
  cd ..
fi

if [ "$CURRICULUM_CHANGED" = true ]; then
  echo "\nüì¶ Running curriculum pre-commit checks..."
  cd curriculum && ./scripts/pre-commit
  if [ $? -ne 0 ]; then
    FAILED=true
  fi
  cd ..
fi

if [ "$INTERPRETERS_CHANGED" = true ]; then
  echo "\nüì¶ Running interpreters pre-commit checks..."
  cd interpreters && ./scripts/pre-commit
  if [ $? -ne 0 ]; then
    FAILED=true
  fi
  cd ..
fi

if [ "$CONTENT_CHANGED" = true ]; then
  echo "\nüì¶ Running content pre-commit checks..."
  cd content && ./scripts/pre-commit
  if [ $? -ne 0 ]; then
    FAILED=true
  fi
  cd ..
fi

if [ "$FAILED" = true ]; then
  echo "\n‚ùå Pre-commit checks failed in one or more packages"
  exit 1
fi

if [ "$APP_CHANGED" = false ] && [ "$CURRICULUM_CHANGED" = false ] && [ "$INTERPRETERS_CHANGED" = false ] && [ "$CONTENT_CHANGED" = false ]; then
  echo "‚úÖ No package files changed, skipping pre-commit checks"
else
  echo "\n‚úÖ All pre-commit checks passed!"
fi
